function [ytmp, y_altn,e_log_y] = cnnSoftmax(zd)
%x=(zd{end,1});
x = zd;
x_roof= max(x);
tmp= bsxfun(@minus,x,x_roof);
%%conventional method
ex_altn = ((1-2*tmp).*(tmp <= 1 & tmp>0))...
    +((1 + tmp).*(tmp<= 0 & tmp >-0.25))+...
    ((0.875 + 0.5*tmp).*(tmp>= -1 & tmp<-0.25))...
    + ((0.625 + 0.25*tmp).*( tmp>=-2  & tmp <-1))...
    + ((0.25 + 0.0625*tmp).*(tmp >= -4 & tmp< -2));%gut angenhert wie  y=exp(tmp);

y_altn= ex_altn(:,:)./(sum(ex_altn(:,:)));

exp_tmp=exp(tmp);
ytmp= exp_tmp(:,:)./sum(exp_tmp(:,:));%control


%%
%log(sum(ex_altn(:,:)));  
a= (sum(ex_altn(:,:)));  
log_app= ((8.25*a-3.125).*(a<=0.125))...
    + ((1.5*a -1.75).*(a<= 0.25 & a >0.125))...
    + ((1.5*a -1.5).*(a< 0.5 & a >0.25))...
    + ((1.25*a -1.25).*( a< 1 & a >=0.5))...
    + ((0.75*a -0.725).*(a< 1.75 & a >=1))...
    + ((0.5*a -0.25).*(a< 2.75 & a >=1.75))...
    + ((0.125*a +0.75).*( a< 4.5 & a >=2.75))...
    + ((0.125*a +1).*( a >=4.5));  

b= log(sum(exp_tmp));       % control
log_y= bsxfun(@minus,tmp,log_app);% nach der formel

%approximate softmax with the result of x_i-x_roof-log(sum(x_j-x_roof))
e_log_y =((-9+log_y*8).*(log_y <= 3 & log_y>2))...
    +((-1+4*log_y).*(log_y<= 2 & log_y>1))...
    +((1-2*log_y).*(log_y <= 1 & log_y>0))...
    +((1 + log_y).*(log_y<= 0 &log_y >-0.25))...
    +((0.875 + 0.5*log_y).*(log_y>= -1 & log_y<-0.25))...
    + ((0.625 + 0.25*log_y).*( log_y>=-2  & log_y <-1))...
    + ((0.25 + 0.0625*log_y).*(log_y >= -4 & log_y< -2));
plot(e_log_y(:,1)-ytmp(:,1),'r')
end
